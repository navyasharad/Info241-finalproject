---
title: "final-project"
output: html_document
date: "2025-12-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#Working directory
getwd()
list.files()
d<- read.csv("Info 241 - VR Curated Data - Sheet1.csv")

library(dplyr)
library(tidyverse)
library(purrr)
library(readr)

theme_set(theme_minimal())
```
```{r}
#Getting column names
colnames(d)
```


```{r}
#Converting time format
str(d$Excitement..scale.1.9.)
str(d$Total.time.spent)

d$Excitement..scale.1.9. <- as.numeric(d$Excitement..scale.1.9.)
Happiness..scale.1.9 <- as.numeric(d$Happiness..scale.1.9)

# Split the string by ":"
time_parts <- strsplit(d$Total.time.spent, ":")
# Convert to total seconds
d$Total.time.spent.sec <- sapply(time_parts, function(x) {
  h <- as.numeric(x[1])
  m <- as.numeric(x[2])
  s <- as.numeric(x[3])
  total_sec <- h*3600 + m*60 + s
  return(total_sec)
})
```
#Run data distributions

```{r}
# Creating a column in the dataset for group
d$group <- ifelse(
  d$Participant.. %in% c(1:6, 17:21, 26:28),
  1,  # glass dome
  2   # brick dome
)

# Check
table(d$group)
head(d)
```

```{r}
colnames(d) <- c("participant", "exposure", "start_time", "end_time", "total_time", "happiness", "excitement", "nausea", "liked_qual", "disliked_qual", "notes", "total_time_sec", "group")

head(d)

d <- d %>%
  mutate(
    total_time_sec = as.numeric(total_time_sec),
    happiness = as.numeric(happiness),
    excitement = as.numeric(excitement),
    nausea = as.numeric(nausea),
    group = as.factor(group)
  )
d

d <- d %>%
  mutate(
    material = case_when(
      (group == 1 & exposure == "First")  ~ "Glass",
      (group == 2 & exposure == "Second") ~ "Glass",
      (group == 1 & exposure == "Second") ~ "Brick",
      (group == 2 & exposure == "First")  ~ "Brick",
      TRUE ~ NA_character_
    )
  )

d <- d %>% mutate(log_time = log(total_time_sec))
qqnorm(d$total_time_sec); qqline(d$total_time_sec)
qqnorm(d$log_time); qqline(d$log_time)

write.csv(d, "d_export.csv", row.names = FALSE)
```
```{r}
#Wide Pivot

d_wide <- d %>%
  select(participant, exposure,
         happiness, excitement, log_time, nausea, group, material, total_time_sec) %>%
  pivot_wider(
    id_cols = participant,
    names_from = exposure,
    values_from = c(happiness, excitement, log_time, nausea, group, material, total_time_sec)
  )
head(d_wide)
```

```{r} #
#Linear model comparing time spent to happiness, excitement, and exposure. Desn't account for two groups.
model<- lm(Total.time.spent.sec ~ Happiness..scale.1.9 + Excitement..scale.1.9. + X1st.or.2nd.environment, data = d, na.action = na.omit)
summary(model)
```

```{r} #
# Subset data for Exposure 1. Did condition affect happiness or excitement?
d_exp1 <- subset(d, X1st.or.2nd.environment == "Second")
d_exp1$Happiness..scale.1.9. <- as.numeric(d_exp1$Happiness..scale.1.9.)
d_exp1$Excitement..scale.1.9. <- as.numeric(d_exp1$Excitement..scale.1.9.)
d_exp1$Total.time.spent.sec <- as.numeric(d_exp1$Total.time.spent.sec)

# Run the linear model on Exposure 1 or 2 only
#On the right side, only pre treatment so cant include nausea
model_happiness <- lm( Happiness..scale.1.9. ~ Condition,
                  data = d_exp1,
                  na.action = na.omit)
model_excitement <- lm(Excitement..scale.1.9. ~ Condition + Total.time.spent.sec + Happiness..scale.1.9.,
                  data = d_exp1,
                  na.action = na.omit)
model_time <- lm( Total.time.spent.sec ~ Condition + Happiness..scale.1.9. + Excitement..scale.1.9.,
                  data = d_exp1,
                  na.action = na.omit)


# View summary
summary(model_happiness)
summary(model_excitement)
summary(model_time)

```
#None of the models are significant. Am I regressing the right thing here? I am envisioning happiness, excitement, and time spent are the DV dependent on condition (but I guess they're not really). I also ran the same models not filtered by exposure, didn't really matter. Does the filter even make sense? 
#Answer: no, cant use post test variables as independent. scrap this.

#Plot Data!
```{r}
library(patchwork)

p1 <- d |> drop_na(happiness) |>
  ggplot(aes(x = factor(happiness, levels = 1:9))) + geom_bar() + labs(x="Happiness", y="Count")

p2 <- d |> drop_na(excitement) |>
  ggplot(aes(x = factor(excitement, levels = 1:9))) + geom_bar() + labs(x="Excitement", y="Count")

p3 <- d |> drop_na(nausea) |>
  ggplot(aes(x = factor(nausea, levels = 1:9))) + geom_bar() + labs(x="Nausea", y="Count")

p4 <- d |> drop_na(log_time) |>
  ggplot(aes(x = log_time)) + geom_histogram(bins = 20, alpha = 0.7) + labs(x="Time Spent (s)", y="Number of People") + theme_minimal(base_size = 12)

# Combine in 2x2
(p1 | p2) / (p3 | p4) + plot_annotation(title = "Likert Scale Distributions (1–9)")


#boxplot(happiness ~ group, data = d)
#boxplot(excitement ~ group, data = d)

#d |> ggplot() + aes(x=as.factor(group), y = happiness) + geom_jitter()

#d |> group_by(group) |> summarise(mean_views = mean(as.numeric(happiness), na.rm = T))
```
```{r}
#Plot data by group

d <- d %>%
  mutate(fill_group = paste0(group, "_", exposure))

# Happiness
p5 <- d |> 
  drop_na(happiness) |>
  ggplot(aes(x = factor(happiness, levels = 1:9),
             fill =  fill_group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c(
    "1_First"   = "#008080",
    "1_Second"  = "orange",
    "2_First"   = "orange",
    "2_Second"  = "#008080"
  )) +
  facet_wrap(~exposure) +
  labs(x = "Happiness", y = "Count", fill = "Exposure") +
  theme_minimal(base_size = 14)

# Excitement
p6 <- d |> 
  drop_na(excitement) |>
  ggplot(aes(x = factor(excitement, levels = 1:9),
             fill =  fill_group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c(
    "1_First"   = "#008080",
    "1_Second"  = "orange",
    "2_First"   = "orange",
    "2_Second"  = "#008080"
  )) +
  facet_wrap(~exposure) +
  labs(x = "Excitement", y = "Count", fill = "exposure") +
  theme_minimal(base_size = 14)

# Nausea
p7 <- d |> 
  drop_na(nausea) |>
  ggplot(aes(x = factor(nausea, levels = 1:9),
             fill = fill_group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c(
    "1_First"   = "#008080",
    "1_Second"  = "orange",
    "2_First"   = "orange",
    "2_Second"  = "#008080"
  )) +
  facet_wrap(~exposure) +
  labs(x = "Nausea", y = "Count", fill = "exposure") +
  theme_minimal(base_size = 14)

facet_labels <- c(First = "Dome", Second = "Cube")
p8 <- d %>%
  drop_na(log_time) %>%
  ggplot(aes(x = log_time, fill = fill_group)) +   # map fill to fill_group!
  geom_histogram(bins = 20, position = "dodge") +
  scale_fill_manual(values = c(
    "1_First"   = "#008080",
    "1_Second"  = "orange",
    "2_First"   = "orange",
    "2_Second"  = "#008080"
  )) +
  facet_wrap(~exposure, labeller = as_labeller(facet_labels)) +
  labs(
    x = "Time Spent (s)",
    y = "Number of People",
    fill = "Material"  # legend title
  ) +
  labs(x = "Time Spent (s)", y = "Number of People")

p5 / p6
p7 / p8



```
```{r}
#Plots split by material

p_hap <- d |> drop_na(happiness) |>
  ggplot(aes(x = factor(happiness, levels = 1:9), fill = material)) + geom_bar(position = "dodge") + labs(x="Happiness", y="Count") + scale_fill_manual(values = c(
              "Glass" = "#008080",  # teal
              "Brick" = "orange"))

p_exc <- d |> drop_na(excitement) |>
  ggplot(aes(x = factor(excitement, levels = 1:9), fill = material)) + geom_bar(position = "dodge") + labs(x="Excitement", y="Count") + scale_fill_manual(values = c(
              "Glass" = "#008080",  # teal
              "Brick" = "orange"))

p_nausea <- d |> drop_na(nausea) |>
  ggplot(aes(x = factor(nausea, levels = 1:9), fill = material)) + geom_bar(position = "dodge") + labs(x="Nausea", y="Count") + scale_fill_manual(values = c(
              "Glass" = "#008080",  # teal
              "Brick" = "orange"))

p_time <- d |> drop_na(total_time_sec) |>
  ggplot(aes(x = total_time_sec, fill = material)) + geom_histogram(position = "dodge", bins = 20) + labs(x="Time Spent (s)", y="Number of People") + scale_fill_manual(values = c(
              "Glass" = "#008080",  # teal
              "Brick" = "orange"))

p_log_time <- d |> drop_na(log_time) |>
  ggplot(aes(x = log_time, fill = material)) + geom_histogram(position = "dodge", bins = 20) + labs(x="Time Spent (s)", y="Number of People") + scale_fill_manual(values = c(
              "Glass" = "#008080",  # teal
              "Brick" = "orange"))

p_log_time

# Combine in 2x2
(p_hap | p_exc) / (p_nausea | p_time)  + plot_annotation(title = "Likert Scale Distributions (1–9)")

```

```{r}
#Within subjects! Filter by condition and then run pairwise ttest
library(dplyr)
library(tidyr)

# Filter for Group 1 (or 2)
d_wide_1 <- d_wide %>%
  filter(group_First == 1)  # change to 2 for Condition 2
d_wide_2 <- d_wide %>%
  filter(group_First == 2)  # change to 2 for Condition 2

# Compute differences
d_wide <- d_wide %>%
  mutate(
    happiness_diff = happiness_Second - happiness_First,
    excitement_diff = excitement_Second - excitement_First,
    time_diff = log_time_Second - log_time_First
  )

# Paired t-tests for this group
t_hap_paired_1 <- t.test(d_wide_1$happiness_First,
                       d_wide_1$happiness_Second,
                       paired = TRUE)
t_hap_paired_2 <- t.test(d_wide_2$happiness_First,
                       d_wide_2$happiness_Second,
                       paired = TRUE)

print ("Happiness t-test within subjects")
print(t_hap_paired_1)
print(t_hap_paired_2)

t_exc_paired_1 <- t.test(d_wide_1$excitement_First,
                       d_wide_1$excitement_Second,
                       paired = TRUE)
t_exc_paired_2 <- t.test(d_wide_2$excitement_First,
                       d_wide_2$excitement_Second,
                       paired = TRUE)

print("Excitement  t-test within subjects")
t_exc_paired_1
t_exc_paired_2


t_time_paired_1 <- t.test(d_wide_1$log_time_First,
                       d_wide_1$log_time_Second,
                       paired = TRUE)
t_time_paired_2 <- t.test(d_wide_2$log_time_First,
                       d_wide_2$log_time_Second,
                       paired = TRUE)

print("Time t-test within subjects")
t_time_paired_1
t_time_paired_2

t.test(d_wide_1$total_time_sec_First,
       d_wide_1$total_time_sec_Second,
       paired = TRUE)
```
#Within subjects condition 1 is glass dome, brick cube and condition 2 is brick dome, glass cube. 
#Questions cond 2
#1. Seems interesting that ttest for time doesnt show a difference in means like at all?
#2. What do we say about a 0.13 p value, it's not sig but what range does it fall in I guess? For happiness
#Questions cond 1
#1. People seem to spend more time in the brick cube than glass dome, p = 0.09. Worth reporting? This seems weird also because it's the second exposure?

```{r}
# Between subjects! Filter for first exposure
d_exp1 <- subset(d, exposure == "First") 
d_exp2 <- subset(d, exposure == "Second")

# Keep only complete cases for Happiness, Excitement, and Group
d_exp1_clean <- d_exp1[!is.na(d_exp1$happiness) &
                         !is.na(d_exp1$excitement) &
                         !is.na(d_exp1$group), ]
d_exp2_clean <- d_exp2[!is.na(d_exp2$happiness) &
                         !is.na(d_exp2$excitement) &
                         !is.na(d_exp2$group), ]


  t_hap <- t.test(happiness ~ group, data = d_exp1_clean)
  t_exc <- t.test(excitement ~ group, data = d_exp1_clean)
  t_time <- t.test(log_time ~ group, data = d_exp1_clean)
  
   t_hap_2 <- t.test(happiness ~ group, data = d_exp2_clean)
  t_exc_2 <- t.test(excitement ~ group, data = d_exp2_clean)
  t_time_2 <- t.test(log_time ~ group, data = d_exp2_clean)
  
  print("Happiness t-test between subjects")
  print(t_hap)
  print(t_hap_2)
  
  print("Excitement t-test between subjects")
  print(t_exc)
  print(t_exc_2)

  print("Time t-test between subjects")
  print(t_time)
  print(t_time_2)

```
#Exposure 2 is brick cube, glass cube
#Questions
#1. we see p = 0.31, happiness in brick cube is higher than glass cube. They're both second exposure, so I think we can compare? Does this p value matter if not sig?
#2. we see p=0.06 for time and that people spend a lot more time in the glass cube than the brick cube. yay! first very close to sig value. but it doesn't line up with happiness and excitement. How do we report this (do we?)?
#Exposure 1 is glass dome, brick dome
#Nothing significant here
#How can we incoprate random inference here? Can we run a randomization for the 1-9 scales and compare our collected survey values to chance? Not sure if this makes sense.
```{r}
#Circumplex Model of Affect
# Create a quadrant variable
d <- d %>%
  mutate(
    quadrant = case_when(
      happiness > 5 & excitement > 5 ~ "High Happiness / High Excitement",
      happiness <= 5 & excitement > 5 ~ "Low Happiness / High Excitement",
      happiness <= 5 & excitement <= 5 ~ "Low Happiness / Low Excitement",
      happiness > 5 & excitement <= 5 ~ "High Happiness / Low Excitement"
    )
  )

# Plot with jitter and quadrants
ggplot(d, aes(x = happiness, y = excitement, color = material, shape = exposure)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.7) +
  geom_vline(xintercept = 5, linetype = "dashed") +
  geom_hline(yintercept = 5, linetype = "dashed") +
  scale_x_continuous(limits = c(1, 9), breaks = 1:9) +
  scale_y_continuous(limits = c(1, 9), breaks = 1:9) +
  labs(
    title = "Happiness vs Excitement by Material",
    x = "Happiness",
    y = "Excitement",
    color = "Material"
  )



```
```{r}
library(purrr)
library(readr)
library(stringr)

#List all HR and EA CSVs recursively, so it searches the file path name and can sort by glass or brick
hr_files <- list.files(pattern = "-HR\\.csv$", full.names = TRUE, recursive = TRUE)
ea_files<- list.files(pattern = "-EA\\.csv$", full.names = TRUE, recursive = TRUE)

#Separate by dome type
hr_glass_files <- hr_files[str_detect(hr_files, "glass")]
hr_brick_files <- hr_files[str_detect(hr_files, "brick")]
print(hr_brick_files)
print(hr_glass_files)

ea_glass_files <- ea_files[str_detect(ea_files, "glass")]
ea_brick_files <- ea_files[str_detect(ea_files, "brick")]

#Function to batch read HR csv files
  read_avg <- function(file) {
  # Extract participant and exposure from filename
  # Example filename: "8-1-HR.csv" → participant 8, exposure 1
  parts <- str_split(basename(file), "-")[[1]]
  participant <- as.integer(parts[1])
  exposure <- parts[2]  # "baseline", "1", "2"
  
  data <- read_csv(file, show_col_types = FALSE)
  avg_value <- mean(data$HR, na.rm = TRUE)
  
  tibble(Participant = participant,
         Exposure = exposure,
         avg_HR = avg_value)
}

#Load HR data
hr_glass <- map_dfr(hr_glass_files, read_avg)
hr_brick <- map_dfr(hr_brick_files, read_avg)

hr_brick_wide <- hr_brick %>%
  pivot_wider(id_cols = Participant,
              names_from = Exposure,
              values_from = avg_HR,
              names_prefix = "HR_") %>%
  mutate(HR_diff_1 = HR_1 - HR_baseline,
         HR_diff_2 = HR_2 - HR_baseline)

hr_glass_wide <- hr_glass %>%
  pivot_wider(id_cols = Participant,
              names_from = Exposure,
              values_from = avg_HR,
              names_prefix = "HR_") %>%
  mutate(HR_diff_1 = HR_1 - HR_baseline,
         HR_diff_2 = HR_2 - HR_baseline)

hr_brick_wide
hr_glass_wide

#Function to batch read EA csv files
  read_avg_1 <- function(file) {
  # Extract participant and exposure from filename
  # Example filename: "8-1-EA.csv" → participant 8, exposure 1
  parts <- str_split(basename(file), "-")[[1]]
  participant <- as.integer(parts[1])
  exposure <- parts[2]  # "baseline", "1", "2"
  
  data <- read_csv(file, show_col_types = FALSE)
  avg_value <- mean(data$EA, na.rm = TRUE)
  
  tibble(Participant = participant,
         Exposure = exposure,
         avg_EA = avg_value)
}

#Load EA data
ea_glass <- map_dfr(ea_glass_files, read_avg_1)
ea_brick <- map_dfr(ea_brick_files, read_avg_1)

ea_glass_wide <- ea_glass %>%
  pivot_wider(id_cols = Participant,
              names_from = Exposure,
              values_from = avg_EA,
              names_prefix = "EA_") %>%
  mutate(EA_diff_1 = EA_1 - EA_baseline,
         EA_diff_2 = EA_2 - EA_baseline)

ea_brick_wide <- ea_brick %>%
  pivot_wider(id_cols = Participant,
              names_from = Exposure,
              values_from = avg_EA,
              names_prefix = "EA_") %>%
  mutate(EA_diff_1 = EA_1 - EA_baseline,
         EA_diff_2 = EA_2 - EA_baseline)

ea_glass_wide
ea_brick_wide
```

#How bout dis? from chat
library(lme4)

# Example: Happiness
model_happiness_mixed <- lmer(Happiness..scale.1.9. ~ Condition + Total.time.spent.sec + Excitement..scale.1.9. + (1 | Participant..),
                              data = d, REML = FALSE)

summary(model_happiness_mixed)


```{r}
#Joining HR and EA to dataset d
library(dplyr)
library(tidyr)

#Combine HR data into one long table with dome type
hr_brick <- hr_brick %>% mutate(Dome = "brick")
hr_glass <- hr_glass %>% mutate(Dome = "glass")

hr_all <- bind_rows(hr_brick, hr_glass) %>%
  select(Participant, Exposure, avg_HR, Dome) %>%
  pivot_wider(names_from = Exposure, values_from = avg_HR, names_prefix = "HR_") 

#Combine EA data similarly
ea_brick <- ea_brick %>% mutate(Dome = "brick")
ea_glass <- ea_glass %>% mutate(Dome = "glass")

ea_all <- bind_rows(ea_brick, ea_glass) %>%
  select(Participant, Exposure, avg_EA, Dome) %>%
  pivot_wider(names_from = Exposure, values_from = avg_EA, names_prefix = "EA_")

#Join HR and EA with main dataset
d<- d %>%
  left_join(hr_all, by = c("participant" = "Participant")) %>%
  left_join(ea_all, by = c("participant" = "Participant", "Dome" = "Dome"))

#Add back the differences
d <- d %>%
  mutate(HR_diff_1 = HR_1 - HR_baseline,
         HR_diff_2 = HR_2 - HR_baseline,
         EA_diff_1 = EA_1 - EA_baseline,
         EA_diff_2 = EA_2 - EA_baseline)

```

```{r}
# Pivot HR columns longer and assign material
d_emoti_long <- d_emoti %>%
  pivot_longer(cols = c(HR_1, HR_2),
               names_to = "exposure",
               values_to = "HR") %>%
  mutate(material = case_when(
    (group == 1 & exposure == "HR_1") | (group == 2 & exposure == "HR_2") ~ "glass",
    (group == 1 & exposure == "HR_2") | (group == 2 & exposure == "HR_1") ~ "brick"
  ))

```

```{r}
#Removing dups
d_emoti <- d %>%
  select(participant, HR_baseline, HR_1, HR_2, HR_diff_1, HR_diff_2, group, EA_1, EA_2, EA_diff_1, EA_diff_2, EA_baseline) %>%
  distinct()

#Plot emoti data

pHR <- d_emoti_long %>%
  ggplot(aes(x = HR, fill = material)) +
  geom_histogram(binwidth = 5, position = "dodge") + 
  scale_fill_manual(values = c(
              "glass" = "#008080",  # teal
              "brick" = "orange")) +
  labs(x = "Heart Rate", y = "Count", fill = "Material") +
  scale_y_continuous(limits = c(0,6))
  
pHR

pHR1 <- d_emoti |>
  ggplot(aes(x = HR_1)) + geom_histogram(binwidth = 5, position = "dodge") + labs(x="Heart Rate: Exposure 1", y="Count") + scale_y_continuous(limits = c(0,6))

pHR2 <- d_emoti |>
  ggplot(aes(x = HR_2)) + geom_histogram(binwidth = 5, position = "dodge") + labs(x="Heart Rate: Exposure 2", y="Count") + scale_y_continuous(limits = c(0,6))

pHR1 + pHR2

ea1 <- d_emoti |>
  ggplot(aes(x = EA_1)) + geom_histogram(position = "dodge") + labs(x="Skin Conductance: Exposure 1", y="Count") + scale_x_continuous(limits = c(0,6))

ea2 <- d_emoti |>
  ggplot(aes(x = EA_2)) + geom_histogram(position = "dodge") + labs(x="Skin Conductance: Exposure 2", y="Count") + scale_x_continuous(limits = c(0,6))

ea1 + ea2

```
```{r}
t.test(d_emoti$HR_baseline, d_emoti$HR_1, paired = TRUE) 
#HR increased a lot from baseline, expected this
#Did the materials have different physiological impacts?
print("Between subjects t-test for HR for exposure 1 and exposure 2")
t.test(HR_diff_1 ~ group, data = d_emoti) #diff 1 is HR_1 - HR_baseline
t.test(HR_diff_2 ~ group, data = d_emoti) #diff 2 is HR_2 - HR_baseline

t.test(d_emoti$HR_1, d_emoti$HR_2, paired = TRUE) #This shows us HR goes down from exposure 1 to 2, which is to be expected? Doesn't account for condition, just within subjects.

#t-test for change in heart rate from 1 to 2 based on condition
d_emoti <- d_emoti %>%
  mutate(HR_change_1to2 = HR_2 - HR_1)
t.test(HR_change_1to2 ~ group, data = d_emoti)
```

#Participants in condition 1 (glass dome + brick cube) showed an increase in HR from baseline to exposure 2 compared to participants in condition 2 (brick dome + glass cube). This was only significant before collapsing the data rows to remove duplicates.

```{r}
t.test(EA_diff_1 ~ group, data = d_emoti |> slice(-6))
t.test(EA_diff_2 ~ group, data = d_emoti)
```
```{r}
#Linear Model
summary(lm(HR ~ exposure + group +exposure*group, data = d_emoti_long))
```
